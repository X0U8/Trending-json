name: Update Trending Music JSON

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

permissions:
  contents: write  

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch YouTube trending data
        env:
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        run: |
          if [ -z "$YOUTUBE_API_KEY" ]; then
            echo "ERROR: API key is not set"
            exit 1
          fi
          
          API_URL="https://www.googleapis.com/youtube/v3/videos?part=snippet,contentDetails&chart=mostPopular&regionCode=US&videoCategoryId=10&maxResults=25&key=${YOUTUBE_API_KEY}"
          
          echo "Fetching trending music videos..."
          RESPONSE=$(curl -s "$API_URL")
          echo "$RESPONSE" > response.json
          
          if echo "$RESPONSE" | grep -q '"error"'; then
            echo "API Error:"
            cat response.json
            exit 1
          fi
          
          echo "✓ Successfully fetched data"

      - name: Generate index.html JSON
        run: |
          node <<'EOF'
          const fs = require('fs');

          const raw = fs.readFileSync('response.json', 'utf8');
          let data;

          try {
            data = JSON.parse(raw);
          } catch {
            console.error("Invalid JSON from API");
            process.exit(1);
          }

          if (!data.items) {
            console.error("YouTube API Error:");
            console.error(JSON.stringify(data, null, 2));
            process.exit(1);
          }

          const items = data.items.map(v => ({
            id: v.id,
            title: v.snippet.title,
            channelTitle: v.snippet.channelTitle,
            thumbnail: v.snippet.thumbnails.high.url,
            duration: v.contentDetails.duration,
            publishedAt: v.snippet.publishedAt
          }));

          const output = {
            updatedAt: new Date().toISOString(),
            region: "US",
            category: "Music",
            count: items.length,
            items
          };

          fs.writeFileSync('index.html', JSON.stringify(output, null, 2));
          console.log("✓ index.html updated with", items.length, "videos");
          EOF

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add index.html
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git commit -m "Update trending music data"
          git push
